
## 16 | 域名解析系统，优化HTTP性能的第一步

### 理解透明多级分流系统的设计原则

用户在使用信息系统的过程中，请求首先是从浏览器出发，在 DNS 的指引下找到系统的入口，然后经过了网关、负载均衡器、缓存、服务集群等一系列设施，最后接触到了系统末端存储于数据库服务器中的信息，然后再逐级返回到用户的浏览器之中

1. 有一些部件位于客户端或网络的边缘，能够迅速响应用户的请求，避免给后方的 I/O 与 CPU 带来压力，典型的如本地缓存、内容分发网络、反向代理等。

2. 有一些部件的处理能力能够线性拓展，易于伸缩，可以通过使用较小的代价堆叠机器，来获得与用户数量相匹配的并发性能，并且应尽量作为业务逻辑的主要载体，典型的如集群中能够自动扩缩的服务节点。

3. 有一些部件的稳定服务，对系统运行具有全局性的影响，要时刻保持着容错备份，维护着高可用性，典型的如服务注册中心、配置中心。

4. 有一些设施是天生的单点部件，只能依靠升级机器本身的网络、存储和运算性能来提升处理能力，比如位于系统入口的路由、网关或者负载均衡器（它们都可以做集群，但一次网络请求中无可避免至少有一个是单点的部件）、位于请求调用链末端的传统关系数据库等，都是典型的容易形成单点部件。

原则:

1) 尽可能减少单点部件，如果某些单点是无可避免的，则应尽最大限度减少到达单点部件的流量。

2) 奥卡姆剃刀原则，它更为关键

在能满足需求的前提下，最简单的系统就是最好的系统。

### 全世界最大规模的查询系统，即 DNS 域名解析查询系统，它是如何实现多级分流的

### DNS 的工作原理

DNS 的作用是把便于人类理解的域名地址，转换为便于计算机处理的 IP 地址。

:: 世界根域名服务器的 ZONE 文件只有 2MB 大小

### Example

1. www.icyfenix.com.cn 

2. 首先，DNS 会把域名还原为“www.icyfenix.com.cn.”。

注意这里最后多了一个点“.”，它是“.root”的意思。

早期的域名都必须得带这个点，DNS 才能正确解析，不过现在几乎所有的操作系统、DNS 服务器都可以自动补上结尾的点号了

3. 客户端先检查本地的 DNS 缓存，查看是否存在并且是存活着的该域名的地址记录。

DNS 是以存活时间（Time to Live，TTL）来衡量缓存的有效情况的，

因此如果某个域名改变了 IP 地址，它也无法去通知缓存了该地址的机器来更新或失效掉缓存，只能依靠 TTL 超期后重新获取来保证一致性。

后续每一级 DNS 查询的过程，都会有类似的缓存查询操作。

4. 客户端将地址发送给本机操作系统中配置的本地 DNS（Local DNS）。

这个本地 DNS 服务器可以由用户手工设置，也可以在 DHCP 分配时或者在拨号时，从 PPP 服务器中自动获取。

5. 本地 DNS 收到查询请求后，会按照

“是否有 www.icyfenix.com.cn 的权威服务器”

→“是否有 icyfenix.com.cn 的权威服务器”

→“是否有 com.cn 的权威服务器”

→“是否有 cn 的权威服务器”的顺序，

依次查询自己的地址记录。

如果都没有查询到，本地 DNS 就会一直找到最后点号代表的根域名服务器为止。

6. 现在假设本地 DNS 是全新的，上面不存在任何域名的权威服务器记录

所以当 DNS 查询请求按步骤 5 的顺序，一直查到根域名服务器之后，它将会得到“cn 的权威服务器”的地址记录，然后通过“cn 的权威服务器”，得到“com.cn 的权威服务器”的地址记录，以此类推，最后找到能够解释 www.icyfenix.com.cn 的权威服务器地址

7. 通过“www.icyfenix.com.cn 的权威服务器”，查询 www.icyfenix.com.cn 的地址记录。

这里的地址记录并不一定就是指 IP 地址，

在 RFC 规范中，有定义的地址记录类型已经多达几十种，

比如 IPv4 下的 IP 地址为 A 记录，IPv6 下的 AAAA 记录、主机别名 CNAME 记录，等等。

此时权威服务器就可以根据自己的策略来进行选择(地区, 服务商)

## 权威域名服务器（Authoritative DNS）

负责翻译特定域名的 DNS 服务器

“权威”的意思就是说，服务器决定了这个域名应该翻译出怎样的结果

DNS 翻译域名的时候，不需要像查电话本一样刻板地一对一翻译，它可以根据来访机器、网络链路、服务内容等各种信息，玩出很多花样(todo : more example)

## 根域名服务器（Root DNS）

是指固定的、无需查询的顶级域名（Top-Level Domain）服务器，可以默认为它们已内置在操作系统代码之中。

全世界一共有 13 组根域名服务器(注意是组而不是台，每一组根域名都通过任播的方式建立了一大群镜像)

13 这数字是因为 

DNS 主要是采用 UDP 传输协议（在需要稳定性保证的时候也可以采用 TCP）来进行数据交换的，未分片的 UDP 数据包在 IPv4 下最大有效值为 512 字节，最多可以存放 13 组地址记录。

### 多级分流带来的问题

1. 响应速度

前端优化手段，叫做DNS 预取（DNS Prefetching）

2. DNS 的分级查询意味着每一级都有可能受到中间人攻击的威胁，产生被劫持的风险。

所以针对这种情况，最近几年出现了一种新的 DNS 工作模式：HTTPDNS（也称为 DNS over HTTPS，DoH）